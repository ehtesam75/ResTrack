{% extends 'marks/base.html' %}

{% block title %}Bulk Exam Entry{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="glass-effect rounded-xl p-6 border border-gray-200 shadow-lg">
        <div class="mb-6">
            <h1 class="text-2xl font-bold gradient-text">Bulk Exam Entry</h1>
            <p class="text-sm text-gray-600 mt-1">Add exam records for multiple students at once</p>
        </div>
        
        {% if not student_count %}
        <!-- Step 1: Ask for number of students -->
        <form method="post" class="space-y-5">
            {% csrf_token %}
            <div class="max-w-md">
                <label for="student_count" class="block text-xs font-semibold text-gray-700 mb-1.5">
                    How many students took this exam? <span class="text-red-500">*</span>
                </label>
                <input 
                    type="number" 
                    id="student_count" 
                    name="student_count" 
                    min="1" 
                    max="50"
                    required
                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                    placeholder="e.g., 3"
                >
                <p class="text-xs text-gray-500 mt-1">Enter the number of students (1-50)</p>
            </div>

            <div class="flex gap-3">
                <button 
                    type="submit" 
                    class="bg-purple-100 text-purple-700 px-6 py-2.5 rounded-lg text-sm font-medium shadow-sm hover:shadow-md hover:bg-purple-200 transition-all"
                >
                    Continue
                </button>
                <a 
                    href="{% url 'add_exam' %}" 
                    class="bg-gray-100 text-gray-700 px-6 py-2.5 rounded-lg text-sm font-medium shadow-sm hover:shadow-md hover:bg-gray-200 transition-all"
                >
                    Back to Single Entry
                </a>
            </div>
        </form>
        
        {% else %}
        <!-- Step 2: Bulk entry form -->
        <form method="post" class="space-y-5">
            {% csrf_token %}
            <input type="hidden" name="student_count" value="{{ student_count }}">
            <input type="hidden" name="submit_exams" value="true">
            
            <!-- Common exam details -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-l-4 border-purple-400 p-4 rounded-lg">
                <h2 class="text-base font-bold gradient-text mb-3">ðŸ“‹ Exam Details (Common for all students)</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="subject" class="block text-xs font-semibold text-gray-700 mb-1.5">
                            Subject <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="subject" 
                            name="subject" 
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white hover:bg-gray-50 transition-colors"
                        >
                            <option value="">Select Subject</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            <a href="{% url 'add_subject' %}" class="text-purple-600 hover:text-purple-800 hover:underline">+ Add new subject</a>
                        </p>
                    </div>

                    <div>
                        <label for="exam_type" class="block text-xs font-semibold text-gray-700 mb-1.5">
                            Exam Type <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="exam_type" 
                            name="exam_type" 
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white hover:bg-gray-50 transition-colors"
                        >
                            <option value="">Select Exam Type</option>
                            <option value="CQ">CQ</option>
                            <option value="MCQ">MCQ</option>
                        </select>
                    </div>

                    <div>
                        <label for="date" class="block text-xs font-semibold text-gray-700 mb-1.5">
                            Date <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="date" 
                            name="date" 
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white hover:bg-gray-50 transition-colors"
                        >
                    </div>

                    <div>
                        <label for="chapter" class="block text-xs font-semibold text-gray-700 mb-1.5">
                            Chapter (Optional)
                        </label>
                        <input 
                            type="text" 
                            id="chapter" 
                            name="chapter"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white hover:bg-gray-50 transition-colors"
                            placeholder="e.g., 5"
                        >
                    </div>

                    <div>
                        <label for="class_number" class="block text-xs font-semibold text-gray-700 mb-1.5">
                            Class <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="class_number" 
                            name="class_number" 
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white hover:bg-gray-50 transition-colors"
                        >
                            <option value="">Select Class</option>
                            <option value="7">Class 7</option>
                            <option value="8">Class 8</option>
                        </select>
                    </div>

                    <div>
                        <label for="total_marks" class="block text-xs font-semibold text-gray-700 mb-1.5">
                            Total Marks <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="total_marks" 
                            name="total_marks" 
                            min="1" 
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white hover:bg-gray-50 transition-colors"
                            placeholder="e.g., 100"
                        >
                    </div>
                </div>
            </div>

            <!-- Students' marks -->
            <div>
                <h2 class="text-base font-bold gradient-text mb-3">ðŸ‘¥ Student Marks ({{ student_count }} students)</h2>
                <div class="space-y-3">
                    {% for i in student_range %}
                    <div class="glass-effect border border-gray-200 rounded-lg p-3 hover:shadow-md transition-all">
                        <h3 class="font-semibold text-gray-700 text-sm mb-2">Student #{{ i }}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="student_{{ i }}" class="block text-xs font-semibold text-gray-700 mb-1.5">
                                    Select Student <span class="text-red-500">*</span>
                                </label>
                                <select 
                                    id="student_{{ i }}" 
                                    name="student_{{ i }}" 
                                    required
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                                >
                                    <option value="">Select Student</option>
                                    {% for student in students %}
                                    <option value="{{ student.id }}">{{ student.name }}</option>
                                    {% endfor %}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    <a href="{% url 'add_student' %}" class="text-purple-600 hover:text-purple-800 hover:underline">+ Add new student</a>
                                </p>
                            </div>
                            <div>
                                <label for="marks_{{ i }}" class="block text-xs font-semibold text-gray-700 mb-1.5">
                                    Marks Obtained <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="number" 
                                    id="marks_{{ i }}" 
                                    name="marks_{{ i }}" 
                                    min="0" 
                                    required
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors marks-input"
                                    placeholder="e.g., 85"
                                >
                                <p class="text-xs text-red-600 mt-1 hidden marks-error">Cannot exceed total marks</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button 
                    type="submit"
                    id="submitBulkBtn"
                    class="bg-green-100 text-green-700 px-6 py-2.5 rounded-lg text-sm font-medium shadow-sm hover:shadow-md hover:bg-green-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    âœ“ Save All Exams
                </button>
                <a 
                    href="{% url 'add_bulk_exams' %}" 
                    class="bg-gray-100 text-gray-700 px-6 py-2.5 rounded-lg text-sm font-medium shadow-sm hover:shadow-md hover:bg-gray-200 transition-all"
                >
                    Start Over
                </a>
                <a 
                    href="{% url 'add_exam' %}" 
                    class="bg-gray-100 text-gray-700 px-6 py-2.5 rounded-lg text-sm font-medium shadow-sm hover:shadow-md hover:bg-gray-200 transition-all"
                >
                    Back to Single Entry
                </a>
            </div>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set today's date as default
    const dateInput = document.getElementById('date');
    if (dateInput) {
        dateInput.valueAsDate = new Date();
    }
    
    // Hide already selected students from dropdowns
    function updateStudentDropdowns() {
        const studentCount = parseInt(document.querySelector('[name="student_count"]')?.value || 0);
        if (!studentCount) return;

        // Collect all selected student IDs
        const selectedStudents = new Set();
        for (let i = 1; i <= studentCount; i++) {
            const select = document.getElementById('student_' + i);
            if (select && select.value) {
                selectedStudents.add(select.value);
            }
        }

        // Update each dropdown
        for (let i = 1; i <= studentCount; i++) {
            const select = document.getElementById('student_' + i);
            if (!select) continue;

            const currentValue = select.value;
            
            // Show/hide options based on selection
            Array.from(select.options).forEach(option => {
                if (option.value === '') {
                    // Always show the "Select Student" placeholder
                    option.style.display = '';
                    option.disabled = false;
                } else if (option.value === currentValue) {
                    // Always show the currently selected option
                    option.style.display = '';
                    option.disabled = false;
                } else if (selectedStudents.has(option.value)) {
                    // Hide options selected in other dropdowns
                    option.style.display = 'none';
                    option.disabled = true;
                } else {
                    // Show unselected options
                    option.style.display = '';
                    option.disabled = false;
                }
            });
        }
    }

    // Attach change listeners to all student dropdowns
    document.addEventListener('DOMContentLoaded', function() {
        const studentCount = parseInt(document.querySelector('[name="student_count"]')?.value || 0);
        for (let i = 1; i <= studentCount; i++) {
            const select = document.getElementById('student_' + i);
            if (select) {
                select.addEventListener('change', updateStudentDropdowns);
            }
        }
    });
    
    // Validate bulk exam form
    const form = document.querySelector('form');
    const submitBulkBtn = document.getElementById('submitBulkBtn');
    
    if (form && form.querySelector('[name="submit_exams"]')) {
        // Real-time validation function
        function validateAllMarks() {
            const totalMarks = parseFloat(document.getElementById('total_marks')?.value);
            const studentCount = parseInt(document.querySelector('[name="student_count"]')?.value || 0);
            let hasError = false;
            let allFieldsFilled = true;
            
            // Check if common fields are filled
            const subject = document.getElementById('subject')?.value;
            const examType = document.getElementById('exam_type')?.value;
            const classNumber = document.getElementById('class_number')?.value;
            const date = document.getElementById('date')?.value;
            
            if (!subject || !examType || !classNumber || !date || !totalMarks) {
                allFieldsFilled = false;
            }
            
            // Check each student's fields
            for (let i = 1; i <= studentCount; i++) {
                const studentSelect = document.getElementById('student_' + i);
                const marksInput = document.getElementById('marks_' + i);
                const marksError = marksInput?.nextElementSibling;
                const markObtained = parseFloat(marksInput?.value);
                
                // Check if student is selected and marks are entered
                if (!studentSelect?.value || !marksInput?.value) {
                    allFieldsFilled = false;
                }
                
                // Check if marks exceed total
                if (marksInput && marksInput.value && totalMarks && markObtained > totalMarks) {
                    marksInput.classList.add('border-red-500');
                    if (marksError && marksError.classList.contains('marks-error')) {
                        marksError.classList.remove('hidden');
                    }
                    hasError = true;
                } else if (marksInput) {
                    marksInput.classList.remove('border-red-500');
                    if (marksError && marksError.classList.contains('marks-error')) {
                        marksError.classList.add('hidden');
                    }
                }
            }
            
            if (submitBulkBtn) {
                submitBulkBtn.disabled = hasError || !allFieldsFilled;
            }
        }
        
        // Real-time validation for each marks input
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('marks-input') || e.target.id === 'total_marks') {
                validateAllMarks();
            }
        });
        
        // Real-time validation for all select dropdowns
        document.addEventListener('change', function(e) {
            if (e.target.tagName === 'SELECT') {
                validateAllMarks();
            }
        });
        
        // Update validation when total marks changes
        const totalMarksInput = document.getElementById('total_marks');
        if (totalMarksInput) {
            totalMarksInput.addEventListener('input', validateAllMarks);
        }
        
        // Update validation when date changes
        const dateInput = document.getElementById('date');
        if (dateInput) {
            dateInput.addEventListener('change', validateAllMarks);
        }
        
        // Initial validation check
        validateAllMarks();
        
        // Form submission validation
        form.addEventListener('submit', function(e) {
            const totalMarks = parseFloat(document.getElementById('total_marks').value);
            const studentCount = parseInt(document.querySelector('[name="student_count"]').value);
            
            for (let i = 1; i <= studentCount; i++) {
                const marksInput = document.getElementById('marks_' + i);
                const markObtained = parseFloat(marksInput.value);
                
                if (markObtained > totalMarks) {
                    e.preventDefault();
                    alert('Student #' + i + ': Marks obtained cannot be greater than total marks!');
                    marksInput.focus();
                    return false;
                }
            }
        });
    }
</script>
{% endblock %}
