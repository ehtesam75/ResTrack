{% extends 'marks/base.html' %}

{% block title %}Add Exam{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="glass-effect rounded-xl p-6 border border-gray-200 shadow-lg animate-fade-in-up">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold gradient-text">Add New Exam</h1>
                <p class="text-sm text-gray-600 mt-1">Enter exam details and marks</p>
            </div>
            <a href="{% url 'add_bulk_exams' %}" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg text-sm font-medium shadow-sm hover:shadow-md hover:bg-purple-200 transition-all">
                ðŸ‘¥ Bulk Entry
            </a>
        </div>
        
        <form method="post" class="space-y-5">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="student" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Student <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="student" 
                        name="student" 
                        required
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                    >
                        <option value="">Select Student</option>
                        {% for student in students %}
                        <option value="{{ student.id }}">{{ student.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        <a href="{% url 'add_student' %}" class="text-purple-600 hover:text-purple-800 hover:underline">+ Add new student</a>
                    </p>
                </div>

                <div>
                    <label for="subject" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Subject <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="subject" 
                        name="subject" 
                        required
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                    >
                        <option value="">Select Subject</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        <a href="{% url 'add_subject' %}" class="text-purple-600 hover:text-purple-800 hover:underline">+ Add new subject</a>
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="exam_id" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Exam ID <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="exam_id" 
                        name="exam_id" 
                        min="1"
                        required
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus-border-transparent bg-gray-50 hover:bg-white transition-colors"
                        placeholder="Enter exam ID manually"
                    >
                </div>
                <div>
                    <label for="exam_type" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Exam Type <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="exam_type" 
                        name="exam_type" 
                        required
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                    >
                        <option value="">Select Exam Type</option>
                        <option value="CQ">CQ</option>
                        <option value="MCQ">MCQ</option>
                    </select>
                </div>

                <div>
                    <label for="class_number" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Class <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="class_number" 
                        name="class_number" 
                        required
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                    >
                        <option value="">Select Class</option>
                        <option value="7">Class 7</option>
                        <option value="8">Class 8</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="date" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Date <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="date" 
                        id="date" 
                        name="date" 
                        required
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                    >
                </div>

                <div>
                    <label for="chapter" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Chapter/Topic (Optional)
                    </label>
                    <input 
                        type="text" 
                        id="chapter" 
                        name="chapter"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                        placeholder="e.g., 5"
                    >
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="total_marks" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Total Marks <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="total_marks" 
                        name="total_marks" 
                        required
                        step="0.01"
                        min="0"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                        placeholder="e.g., 100"
                    >
                </div>

                <div>
                    <label for="mark_obtained" class="block text-xs font-semibold text-gray-700 mb-1.5">
                        Marks Obtained <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="mark_obtained" 
                        name="mark_obtained" 
                        required
                        step="0.01"
                        min="0"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-gray-50 hover:bg-white transition-colors"
                        placeholder="e.g., 85"
                    >
                    <p class="text-xs text-red-600 mt-1 hidden" id="marks-error">Cannot exceed total marks</p>
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button 
                    type="submit"
                    id="submitBtn"
                    class="flex-1 bg-purple-100 text-purple-700 font-medium py-2.5 rounded-lg text-sm shadow-sm hover:shadow-md hover:bg-purple-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Add Exam
                </button>
                <a 
                    href="{% url 'dashboard' %}"
                    class="flex-1 bg-gray-100 text-gray-700 font-medium py-2.5 rounded-lg text-center text-sm shadow-sm hover:shadow-md hover:bg-gray-200 transition-all"
                >
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set today's date as default
    document.getElementById('date').valueAsDate = new Date();
    
    const totalMarksInput = document.getElementById('total_marks');
    const markObtainedInput = document.getElementById('mark_obtained');
    const marksError = document.getElementById('marks-error');
    const submitBtn = document.getElementById('submitBtn');
    const studentSelect = document.getElementById('student');
    const subjectSelect = document.getElementById('subject');
    const examTypeSelect = document.getElementById('exam_type');
    const classSelect = document.getElementById('class_number');
    const dateInput = document.getElementById('date');
    
    // Validate all fields
    function validateForm() {
        const totalMarks = parseFloat(totalMarksInput.value);
        const markObtained = parseFloat(markObtainedInput.value);
        let hasError = false;
        let allRequiredFilled = true;
        
        // Check all required fields
        if (!studentSelect.value || !subjectSelect.value || !examTypeSelect.value || 
            !classSelect.value || !dateInput.value || !totalMarksInput.value || !markObtainedInput.value) {
            allRequiredFilled = false;
        }
        
        // Check if marks obtained exceeds total marks
        if (markObtainedInput.value && totalMarksInput.value && markObtained > totalMarks) {
            marksError.classList.remove('hidden');
            markObtainedInput.classList.add('border-red-500');
            hasError = true;
        } else {
            marksError.classList.add('hidden');
            markObtainedInput.classList.remove('border-red-500');
        }
        
        submitBtn.disabled = hasError || !allRequiredFilled;
    }
    
    // Real-time validation
    markObtainedInput.addEventListener('input', validateForm);
    totalMarksInput.addEventListener('input', validateForm);
    studentSelect.addEventListener('change', validateForm);
    subjectSelect.addEventListener('change', validateForm);
    examTypeSelect.addEventListener('change', validateForm);
    classSelect.addEventListener('change', validateForm);
    dateInput.addEventListener('change', validateForm);
    
    // Initial validation check
    validateForm();
    
    // Validate that marks obtained is not greater than total marks
    document.querySelector('form').addEventListener('submit', function(e) {
        const totalMarks = parseFloat(totalMarksInput.value);
        const markObtained = parseFloat(markObtainedInput.value);
        
        if (markObtained > totalMarks) {
            e.preventDefault();
            alert('Marks obtained cannot be greater than total marks!');
            return false;
        }
    });
</script>
{% endblock %}
